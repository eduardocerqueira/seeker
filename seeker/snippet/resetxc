#date: 2022-07-20T17:13:56Z
#url: https://api.github.com/gists/bee838e0bba611b6f1d3a5cc1ba03a16
#owner: https://api.github.com/users/jkereako

#!/usr/bin/env bash
#
# resetxc
# Copyright (c) 2022 - Jeff Kereakoglow
#
# Kills Xcode, deletes all caches and build artifacts and re-opens Xcode

set -Eeuo pipefail

# Print out error messages to STDERR.
function err() {
  echo -e "\033[0;31mERROR: $@\033[0m" >&2;
}

function check_git() {
    if [ ! -d .git ]; then
        err "Current directory is not tracked with Git"; exit 2;
    fi;
}

function kill() {
    killall Xcode
    xcrun -k
}

function clean() {
    # xcodebuild -alltargets clean
    git clean -xfd
    rm -rf "$(getconf DARWIN_USER_CACHE_DIR)/org.llvm.clang/ModuleCache"
    rm -rf "$(getconf DARWIN_USER_CACHE_DIR)/org.llvm.clang.$(whoami)/ModuleCache"
    rm -rf ~/Library/Developer/Xcode/DerivedData/*
    rm -rf ~/Library/Caches/com.apple.dt.Xcode/*
}

function open_xcode_project() {
    root_dir=$(git rev-parse --show-toplevel)
    xcode_proj=$(find . -name "*.xcodeproj" | head -n 1)
    # Trim the leading "./"
    proj_url="${root_dir}/${xcode_proj#"./"}"
    
    # xed â€“ Xcode text editor invocation tool.
    # xed was introduced in Mac OS X 10.5 with Xcode 3.0.u
    xed -b "${proj_url}"
}

#-- Main
function main() {
    check_git

    # Kill Xcode if it's running
    if pgrep Xcode; then
        # Kill
        echo "ðŸ’€ Killing Xcode..."
        kill
    fi

    # Clean
    echo "ðŸ§¹ Cleaning targets and caches..."
    clean

    # Open
    open_xcode_project

    echo "âœ… Done!"
}

main "$@"
