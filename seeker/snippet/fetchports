#date: 2022-05-13T17:18:35Z
#url: https://api.github.com/gists/24cbd3de2f94dc19043993f31b11caad
#owner: https://api.github.com/users/steakknife

#!/usr/bin/env sh
set -e
cd /tmp
ftp https://cdn.openbsd.org/pub/OpenBSD/$(uname -r)/{ports.tar.gz,SHA256.sig}
signify -Cp /etc/signify/openbsd-$(uname -r | cut -c 1,3)-base.pub -x SHA256.sig ports.tar.gz
cd /usr
rm -rf ports
tar xzf /tmp/ports.tar.gz
rm -f /tmp/{ports.tar.gz,SHA256.sig}

chown -R _pfetch:_pfetch /usr/distfiles
chown -R _pbuild:_pbuild /usr/ports/{plist,bulk} /usr/packages /usr/obj/ports

# 770 -> 775
chmod 775 /usr/obj

cat << NOTES
Make the following changes:

Note: {{user}} can be root or another user because PRIV_SEP makes it safe.

/etc/doas.conf:

permit keepenv nopass {{user}} as _pbuild
permit keepenv nopass {{user}} as _pfetch
permit keepenv nopass {{user}} as root

/etc/mk.conf:

WRKOBJDIR=/usr/obj/ports
DISTDIR=/usr/distfiles
PACKAGE_REPOSITORY=/usr/packages
PORTS_PRIVSEP=yes
SUDO=doas

NOTES