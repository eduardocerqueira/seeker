#date: 2024-06-21T16:53:18Z
#url: https://api.github.com/gists/78bd69219dc2e4865c1bf50ee623c762
#owner: https://api.github.com/users/vitalwarley

#!/bin/bash

# Variables
BOOT_PARTITION="/dev/nvme0n1p1"
SYSTEM_PARTITION="/dev/nvme0n1p2"
BOOT_DRIVE="/dev/nvme0n1"
LUKS_NAME="cryptroot"
MOUNT_POINT="/mnt"
BTRFS_SUBVOLUME="@"

# Functions
mount_partitions() {
    echo "Opening LUKS container..."
    cryptsetup open $SYSTEM_PARTITION $LUKS_NAME
    if [ $? -ne 0 ]; then
        echo "Failed to open LUKS container."
        exit 1
    fi

    echo "Mounting Btrfs filesystem..."
    mount -o subvol=$BTRFS_SUBVOLUME /dev/mapper/$LUKS_NAME $MOUNT_POINT
    if [ $? -ne 0 ]; then
        echo "Failed to mount Btrfs filesystem."
        exit 1
    fi

    echo "Mounting boot partition..."
    mount $BOOT_PARTITION $MOUNT_POINT/boot
    if [ $? -ne 0 ]; then
        echo "Failed to mount boot partition."
        exit 1
    fi

    echo "Mounting system directories..."
    mount -t proc /proc $MOUNT_POINT/proc
    mount --rbind /sys $MOUNT_POINT/sys
    mount --rbind /dev $MOUNT_POINT/dev
    mount --bind /run $MOUNT_POINT/run
}

chroot_and_fix() {
    echo "Chrooting into the installed system..."
    arch-chroot $MOUNT_POINT /bin/bash <<EOF
    echo "Reinstalling GRUB..."
    grub-install $BOOT_DRIVE
    if [ $? -ne 0 ]; then
        echo "Failed to install GRUB."
        exit 1
    fi

    echo "Generating GRUB configuration..."
    grub-mkconfig -o /boot/grub/grub.cfg
    if [ $? -ne 0 ]; then
        echo "Failed to generate GRUB configuration."
        exit 1
    fi

    echo "Updating the system..."
    pacman -Syu --noconfirm
    if [ $? -ne 0 ]; then
        echo "Failed to update the system."
        exit 1
    fi

    echo "Checking the filesystem..."
    btrfs check /dev/mapper/$LUKS_NAME
    if [ $? -ne 0 ]; then
        echo "Filesystem check failed."
        exit 1
    fi

    echo "Exiting chroot environment..."
    exit
EOF
}

unmount_partitions() {
    echo "Unmounting partitions..."
    umount -R $MOUNT_POINT
    cryptsetup close $LUKS_NAME
}

# Main script execution
echo "Starting boot fix process..."

mount_partitions
if [ $? -eq 0 ]; then
    chroot_and_fix
    unmount_partitions
    echo "Boot fix process completed. Please remove the USB stick and reboot your system."
else
    echo "Failed to mount partitions. Exiting."
fi

exit 0