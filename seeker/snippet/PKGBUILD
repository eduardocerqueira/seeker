#date: 2025-12-09T17:15:21Z
#url: https://api.github.com/gists/e05f12ab5fed532c78e64d6ddc936f24
#owner: https://api.github.com/users/Neycrol

# Maintainer: Kyle De'Vir (QuartzDragon) <kyle.devir.mykolab.com>
# Contributor: neycrol <330578697@qq.com>

pkgname=bcachefs-tools-git
_pkgname=bcachefs-tools
pkgver=0.r0.g0000000
pkgrel=1
pkgdesc="Bcachefs userspace tools (Git version) with FUSE support enabled"
arch=('x86_64')
url="https://bcachefs.org/"
license=('GPL-2.0-only')
provides=("$_pkgname")
conflicts=("$_pkgname")

depends=(
    'glibc'
    'libaio'
    'util-linux-libs'
    'keyutils'
    'libsodium'
    'liburcu'
    'zlib'
    'zstd'
    'lz4'
    'systemd-libs'
    'fuse3'
)
makedepends=(
    'git'
    'rust'
    'cargo'
    'clang'
    'llvm'
    'pkgconf'
)

source=("git+https://github.com/koverstreet/bcachefs-tools.git")
sha256sums=('SKIP')

# Disable LTO to prevent issues with Rust's ThinLTO
options=('!lto')

pkgver() {
    cd "$_pkgname"
    printf "r%s.g%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
    cd "$_pkgname"
    export RUSTUP_TOOLCHAIN=stable
    cargo fetch --locked --target "$CARCH-unknown-linux-gnu"
}

build() {
    cd "$_pkgname"

    # Use system CFLAGS/LDFLAGS for Rust
    export RUSTFLAGS="-C link-arg=$LDFLAGS"

    make \
        BCACHEFS_FUSE=1 \
        PREFIX=/usr \
        ROOT_SBINDIR=/usr/bin \
        LIBEXECDIR=/usr/lib \
        INITRAMFS_DIR=/usr/lib/initcpio \
        all
    
    # Generate shell completions using the built binary
    local _bin="./target/release/bcachefs"
    if [ -x "$_bin" ]; then
        msg2 "Generating shell completions..."
        "$_bin" completions bash > bcachefs.bash
        "$_bin" completions zsh  > _bcachefs
        "$_bin" completions fish > bcachefs.fish
    fi
}

package() {
    cd "$_pkgname"

    make \
        BCACHEFS_FUSE=1 \
        PREFIX=/usr \
        ROOT_SBINDIR=/usr/bin \
        LIBEXECDIR=/usr/lib \
        INITRAMFS_DIR=/usr/lib/initcpio \
        DESTDIR="$pkgdir" \
        install

    # REMOVE DKMS SOURCE INSTALLED BY MAKEFILE
    # This package provides userspace tools only. The kernel module should be 
    # managed by 'bcachefs-kernel-dkms-git' or official packages to avoid
    # version mismatch and stale drivers.
    rm -rf "$pkgdir/usr/src"

    # Install License
    install -Dm644 COPYING "$pkgdir/usr/share/licenses/$pkgname/LICENSE"

    # Install Shell Completions
    if [ -f bcachefs.bash ]; then
        install -Dm644 bcachefs.bash "$pkgdir/usr/share/bash-completion/completions/bcachefs"
        install -Dm644 _bcachefs      "$pkgdir/usr/share/zsh/site-functions/_bcachefs"
        install -Dm644 bcachefs.fish  "$pkgdir/usr/share/fish/vendor_completions.d/bcachefs.fish"
    fi
}