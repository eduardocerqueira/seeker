#date: 2025-08-20T17:02:33Z
#url: https://api.github.com/gists/20289cf96c8425f33b6ce17c3e89d829
#owner: https://api.github.com/users/Bryan2333

#!/bin/bash

# Copy to /etc/NetworkManager/dispatcher.d/tproxy-dispatcher

DEVICE_IFACE="$1"
ACTION="$2"
LOCK_FILE="/dev/shm/tproxy-dispatcher.lock"

exec 9>"$LOCK_FILE"
flock -n 9 || exit 0

[[ "$DEVICE_IFACE" =~ ^(wlan|ens|eth) ]] || exit 0

command -v singbox-tproxy > /dev/null 2>&1 || exit 0

declare -A ACTION_MAP=(
    ["up"]="start"              # 接口已启用，启动代理
    ["down"]="stop"             # 接口关闭时，停止代理
    ["pre-up"]="stop"           # 接口即将启用，可以先停止旧实例，避免地址变化导致规则错乱
    ["dhcp4-change"]="restart"  # DHCP地址变更，刷新代理规则
    ["dhcp6-change"]="restart"  # 同上  
)

[[ -n "${ACTION_MAP[$ACTION]}" ]] && singbox-tproxy "${ACTION_MAP[$ACTION]}"
