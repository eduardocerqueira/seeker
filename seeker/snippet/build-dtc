#date: 2024-02-26T16:57:26Z
#url: https://api.github.com/gists/c0ff7da9cb72008c2252bce14e2a0463
#owner: https://api.github.com/users/Manouchehri

#!/usr/bin/env dash
#
# SPDX-License-Identifer: Unlicense
#

CC=clang
LD=ld.lld
STRIP=llvm-strip

# -fuse-ld= tells compiler to use specific linker above
USE_LD=$(echo $LD | cut -d. -f2)

# Limits to at least Intel Nehalem and newer
ARCH=x86-64-v2
# Optimize binary for this specific CPU
TUNE=skylake

# Compiler optimizations and hardenings
CFLAGS="-O3 -g0 -fcf-protection=full -fstack-clash-protection -fstack-protector-all"
# LLVM-specific hardening, automatically init values with zeroes
CFLAGS="$CFLAGS -ftrivial-auto-var-init=zero -enable-trivial-auto-var-init-zero-knowing-it-will-be-removed-from-clang"
# Disable unused command line warning (happens during final link)
CFLAGS="$CFLAGS -Wno-unused-command-line-argument"

# Defaults as specified in Makefile
CPPFLAGS="-Ilibfdt -I. -DFDT_ASSUME_MASK=0"
# Disable linking with libyaml and valgrind
CPPFLAGS="$CPPFLAGS -DNO_VALGRIND -DNO_YAML"

# Linker optimization and static-PIE linking
LDFLAGS="-Wl,-O3 -static-pie"

# Removes all symbols
STRIPFLAGS="-s"

# Fix building/linking of the AOSP fork (upstream dtc isn't affected)
grep dtc-parser.h dtc-lexer.l && sed s/dtc-parser/dtc-parser.tab/ -i dtc-lexer.l

make -j"$(nproc --all)" \
    CC=$CC \
    CPPFLAGS="$CPPFLAGS" \
    EXTRA_CFLAGS="-march=$ARCH -mtune=$TUNE $CFLAGS" \
    LDFLAGS="-fuse-ld=$USE_LD $LDFLAGS" \
    dtc

$STRIP $STRIPFLAGS dtc

ls -l dtc
sha256sum dtc
