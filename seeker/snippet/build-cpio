#date: 2024-02-26T16:57:26Z
#url: https://api.github.com/gists/c0ff7da9cb72008c2252bce14e2a0463
#owner: https://api.github.com/users/Manouchehri

#!/usr/bin/env dash
#
# SPDX-License-Identifier: Unlicense
#

CC=clang
LD=ld.lld
STRIP=llvm-strip

# -fuse-ld= tells compiler to use specific linker above
USE_LD=$(echo $LD | cut -d. -f2)

# Limits to at least Intel Nehalem and newer
ARCH=x86-64-v2
# Optimize binary for this specific CPU
TUNE=skylake

# Compiler optimizations and hardenings
CFLAGS="-O3 -g0 -fcf-protection=full -fstack-clash-protection -fstack-protector-all"
# LLVM-specific hardening, automatically init values with zeroes
CFLAGS="$CFLAGS -ftrivial-auto-var-init=zero -enable-trivial-auto-var-init-zero-knowing-it-will-be-removed-from-clang"
# Disable unused command line warning (happens during final link)
CFLAGS="$CFLAGS -Wno-unused-command-line-argument"

# Linker optimization and static-PIE linking
LDFLAGS="-Wl,-O3 -static-pie"

# Removes all symbols
STRIPFLAGS="-s"

# Comment: Probably --disable-rpath does nothing to static build?
./configure \
    CC=$CC \
    CFLAGS="-march=$ARCH -mtune=$TUNE $CFLAGS" \
    LDFLAGS="-fuse-ld=$USE_LD $LDFLAGS" \
    --prefix=/usr \
    --disable-rpath

# Remove unused declaration to fix static linking
grep program_name src/global.c && sed /program_name/d -i src/global.c

make -j"$(nproc --all)"

$STRIP $STRIPFLAGS src/cpio

ls -l src/cpio
sha256sum src/cpio
