#date: 2022-01-14T16:56:45Z
#url: https://api.github.com/gists/4942d920b92fbbb284862eb679b08355
#owner: https://api.github.com/users/msekletar

#!/bin/bash -x

set -eu
set -o pipefail

LONGPATH="/111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111/222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222/333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333/444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444/555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555/666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666/777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777"
LONGMNT="$(systemd-escape --suffix=mount --path $LONGPATH)"
TS="$(date '+%H:%M:%S')"

trap "umount $LONGPATH" EXIT

mkdir -p $LONGPATH
mount -t tmpfs tmpfs $LONGPATH
systemctl daemon-reload

# Check that unit is active(mounted)
systemctl --no-pager show -p SubState --value $LONGPATH | grep -q mounted

# Check that relevant part of journal doesn't contain any errors related to unit
[ $(journalctl -b --since=$TS --priority=err | grep "$LONGMNT"  | wc -l) = "0" ]

echo 'PASS'