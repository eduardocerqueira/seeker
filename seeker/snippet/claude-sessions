#date: 2026-02-06T17:33:51Z
#url: https://api.github.com/gists/735eca1dca19bf1ac158aa3d02b26a62
#owner: https://api.github.com/users/CyPack

#!/usr/bin/env python3
"""Claude Code session lookup - /rename ile isimlendirilmis sessionlari bulur.

Usage:
    claude-sessions search <name>    # UUID|CWD doner (ca fonksiyonu icin)
    claude-sessions list             # tum renamed sessionlari listeler
    claude-sessions peek <name>      # session'in son mesajlarini gosterir
"""

import json, os, glob, sys, time

PROJECTS_DIR = os.path.expanduser("~/.claude/projects")

# ANSI colors
C_RESET = "\033[0m"
C_CYAN = "\033[1;36m"
C_YELLOW = "\033[0;33m"
C_WHITE = "\033[0;37m"
C_RED = "\033[1;31m"
C_DIM = "\033[2m"
C_GREEN = "\033[0;32m"


def scan_sessions():
    """Tum JSONL dosyalarini tarayip renamed sessionlari doner."""
    results = []
    for projdir in glob.glob(os.path.join(PROJECTS_DIR, "*")):
        for f in glob.glob(os.path.join(projdir, "*.jsonl")):
            sid = os.path.basename(f).replace(".jsonl", "")
            try:
                cwd = ""
                title = ""
                for line in open(f):
                    try:
                        d = json.loads(line)
                    except:
                        continue
                    if not cwd and d.get("cwd"):
                        cwd = d["cwd"]
                    if d.get("type") == "custom-title":
                        title = d.get("customTitle", "")
                if title:
                    results.append({
                        "title": title,
                        "sid": sid,
                        "cwd": cwd or os.path.expanduser("~"),
                        "mtime": os.path.getmtime(f),
                        "size": os.path.getsize(f) / 1024,
                        "path": f,
                        "projdir": projdir,
                    })
            except:
                pass
    results.sort(key=lambda x: -x["mtime"])
    return results


def find_match(name):
    """Isimle eslesme bul. (match, all_sessions, scanned_dirs) doner."""
    search = name.lower()
    sessions = scan_sessions()
    scanned_dirs = set()
    for projdir in glob.glob(os.path.join(PROJECTS_DIR, "*")):
        scanned_dirs.add(projdir)
    exact = [s for s in sessions if s["title"].lower() == search]
    partial = [s for s in sessions if search in s["title"].lower() and s["title"].lower() != search]
    match = (exact or partial or [None])[0]
    return match, sessions, scanned_dirs


def print_not_found(name, sessions, scanned_dirs):
    """Agent-friendly 'bulunamadi' mesaji."""
    print(f"\n  {C_RED}Session '{name}' bulunamadi.{C_RESET}\n")
    print(f"  {C_DIM}Aranan dizin:{C_RESET}  {PROJECTS_DIR}/")
    print(f"  {C_DIM}Taranan proje:{C_RESET}  {len(scanned_dirs)} dizin")
    jsonl_count = sum(1 for d in scanned_dirs for _ in glob.glob(os.path.join(d, "*.jsonl")))
    print(f"  {C_DIM}Taranan JSONL:{C_RESET}  {jsonl_count} dosya")
    print(f"  {C_DIM}Aranan alan:{C_RESET}   type:custom-title → customTitle icinde \"{name}\"")
    print()
    if sessions:
        print(f"  {C_GREEN}Mevcut renamed session'lar:{C_RESET}")
        for s in sessions:
            ts = time.strftime("%Y-%m-%d %H:%M", time.localtime(s["mtime"]))
            print(f"    {C_CYAN}{s['title']:15s}{C_RESET}  {ts}  {s['cwd']}")
        print(f"\n  {C_DIM}Ipucu: Claude Code icinde /rename {name} komutuyla session isimlendir.{C_RESET}")
    else:
        print(f"  {C_YELLOW}Hic renamed session yok.{C_RESET}")
        print(f"  {C_DIM}Ipucu: Claude Code icinde /rename <isim> komutuyla session isimlendir.{C_RESET}")
    print()


def print_cwd_warning(match):
    """CWD dizini yoksa agent-friendly uyari."""
    cwd = match["cwd"]
    if os.path.isdir(cwd):
        return False
    print(f"\n  {C_YELLOW}CWD dizini bulunamadi!{C_RESET}\n")
    print(f"  {C_DIM}Session:{C_RESET}      {C_CYAN}{match['title']}{C_RESET}")
    print(f"  {C_DIM}UUID:{C_RESET}         {match['sid']}")
    print(f"  {C_DIM}JSONL:{C_RESET}        {match['path']}")
    print(f"  {C_DIM}Kayitli CWD:{C_RESET}  {C_RED}{cwd}{C_RESET}  ← bu dizin artik yok")
    print()
    # Parent dizinleri kontrol et
    parts = cwd.rstrip("/").split("/")
    for i in range(len(parts), 0, -1):
        parent = "/".join(parts[:i]) or "/"
        if os.path.isdir(parent):
            print(f"  {C_DIM}En yakin mevcut parent:{C_RESET}  {C_GREEN}{parent}{C_RESET}")
            break
    print(f"\n  {C_DIM}Ipucu: Session ~ (home) dizininden resume edilecek.{C_RESET}")
    print()
    return True


def cmd_search(name):
    """Session ara, UUID|CWD dondur. CWD yoksa fallback home + stderr uyari."""
    match, sessions, scanned_dirs = find_match(name)
    if not match:
        print_not_found(name, sessions, scanned_dirs)
        sys.exit(1)

    cwd = match["cwd"]
    if not os.path.isdir(cwd):
        # stderr'e uyari, stdout'a fallback CWD
        print_cwd_warning(match)
        cwd = os.path.expanduser("~")

    print(f'{match["sid"]}|{cwd}')


def cmd_list():
    """Tum renamed sessionlari listele."""
    sessions = scan_sessions()
    if not sessions:
        print(f"\n  {C_YELLOW}Renamed session bulunamadi.{C_RESET}")
        print(f"  {C_DIM}Claude Code icinde /rename <isim> kullan.{C_RESET}\n")
        return
    print(f"\n  Claude Code Sessions ({len(sessions)} renamed)\n")
    for s in sessions:
        ts = time.strftime("%Y-%m-%d %H:%M", time.localtime(s["mtime"]))
        size = f'{s["size"]:.0f} KB' if s["size"] < 1024 else f'{s["size"]/1024:.1f} MB'
        cwd_ok = os.path.isdir(s["cwd"])
        cwd_marker = "" if cwd_ok else f"  {C_RED}(dizin yok!){C_RESET}"
        print(f'  {C_CYAN}{s["title"]:15s}{C_RESET}  {ts}  {size:>8s}  {s["cwd"]}{cwd_marker}')
    print()


def cmd_peek(name):
    """Session'in son kullanici/asistan mesajlarini goster."""
    match, sessions, scanned_dirs = find_match(name)
    if not match:
        print_not_found(name, sessions, scanned_dirs)
        sys.exit(1)

    messages = []
    for line in open(match["path"]):
        try:
            d = json.loads(line)
        except:
            continue
        t = d.get("type", "")
        if t not in ("user", "assistant"):
            continue
        msg = d.get("message", {})
        if not isinstance(msg, dict):
            continue
        content = msg.get("content", "")
        text = ""
        if isinstance(content, list):
            for c in content:
                if isinstance(c, dict) and c.get("type") == "text":
                    text = c.get("text", "").strip()
                    break
        elif isinstance(content, str):
            text = content.strip()
        if text and not text.startswith("<"):
            role = "USER" if t == "user" else "ASST"
            messages.append((role, text))

    ts = time.strftime("%Y-%m-%d %H:%M", time.localtime(match["mtime"]))
    cwd_ok = os.path.isdir(match["cwd"])
    cwd_line = match["cwd"] if cwd_ok else f'{C_RED}{match["cwd"]}  (dizin yok!){C_RESET}'
    print(f'\n  {C_CYAN}{match["title"]}{C_RESET}  ({ts})')
    print(f'  {cwd_line}')
    print(f'  {"─" * 60}')

    # Son 6 mesaj
    for role, text in messages[-6:]:
        preview = text[:120].replace("\n", " ")
        color = C_YELLOW if role == "USER" else C_WHITE
        print(f"  {color}{role:4s}{C_RESET}  {preview}")
    print()


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print(__doc__)
        sys.exit(1)

    cmd = sys.argv[1]
    if cmd == "search" and len(sys.argv) >= 3:
        cmd_search(sys.argv[2])
    elif cmd == "list":
        cmd_list()
    elif cmd == "peek" and len(sys.argv) >= 3:
        cmd_peek(sys.argv[2])
    else:
        print(__doc__)
        sys.exit(1)
