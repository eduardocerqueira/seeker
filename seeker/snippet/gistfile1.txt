#date: 2025-10-23T17:11:34Z
#url: https://api.github.com/gists/c82432550fe28deb6462d2d3770ca147
#owner: https://api.github.com/users/kosyan62

#!/usr/bin/env bash
set -euo pipefail

KEEPASS_DB_PATH=""
CISCO_ANYCONNECT_PATH=""
KEEPASS_ENTRY=""

trap 'unset KEEPASS_PASSWORD; echo; echo "Aborted."; exit 1' INT TERM

# Ensure required variables are set
if [[ -z "$KEEPASS_DB_PATH" || -z "$CISCO_ANYCONNECT_PATH" || -z "$KEEPASS_ENTRY" ]]; then
    echo "Error: Please set KEEPASS_DB_PATH, CISCO_ANYCONNECT_PATH, and KEEPASS_ENTRY." >&2
    exit 1
fi

# Prompt securely for KeePass password
read -rsp "Please provide KeePass password: "**********"
echo

# Verify password early
if ! printf %s "$KEEPASS_PASSWORD" | keepassxc-cli ls -q "$KEEPASS_DB_PATH" >/dev/null 2>&1; then
    echo "Invalid KeePass password or cannot open database." >&2
    exit 1
fi

# Function to extract a field from KeePass safely
get_keepass_field() {
    local field=$1
    printf %s "$KEEPASS_PASSWORD" | \
        keepassxc-cli show -a "$field" -q "$KEEPASS_DB_PATH" "$KEEPASS_ENTRY" 2>/dev/null || true
}

USERNAME=$(get_keepass_field username)
ANYCONNECT_URL=$(get_keepass_field URL)
PASSWORD= "**********"

if [[ -z "$USERNAME" || -z "$PASSWORD" || -z "$ANYCONNECT_URL" ]]; then
    echo "Failed: Problem reading entry from KeePass"
    exit 1
fi

# Optional: print debug line
#echo "Connecting to: $ANYCONNECT_URL with user $USERNAME"

# Connect
printf "%s\n%s\n" "$USERNAME" "$PASSWORD" | "$CISCO_ANYCONNECT_PATH" -s connect "$ANYCONNECT_URL"

# Clean up sensitive vars
unset USERNAME PASSWORD KEEPASS_PASSWORD
WORD KEEPASS_PASSWORD
