#date: 2025-07-04T16:54:49Z
#url: https://api.github.com/gists/11f29a85349cd92e7c8aaad53b268069
#owner: https://api.github.com/users/Admintop2025

#!/bin/bash
# install-amdy-vicidial12-safe.sh
# Advanced AMD installer for Vicidial v12 with safe dialplan injection

set -e

### 1️⃣ Pre-check and backup
echo "🔹 Checking Python 3.6..."
if ! command -v python3.6 &>/dev/null; then
  echo "❌ Python 3.6 is not installed. Install it before running this script."
  exit 1
fi

echo "🔹 Backing up configs..."
timestamp=$(date +%F-%H-%M)
cp /etc/asterisk/extensions.conf /etc/asterisk/extensions.conf.bak.$timestamp
cp /etc/asterisk/amd.conf /etc/asterisk/amd.conf.bak.$timestamp

### 2️⃣ Install dependencies
echo "🔹 Installing Python dependencies..."
zypper in -y python3-pip || true
pip3 install --upgrade pip
pip3.6 install pyst2 websocket-client mysql-connector-python==8.0.29 configparser --upgrade

### 3️⃣ Download and extract AMDY package
echo "🔹 Downloading and extracting AMDY package..."
wget -N -O amdy.tar.gz http://download.amdy.io/amdy.tar.gz
tar zxvf amdy.tar.gz --directory /var/lib/asterisk/agi-bin
chmod a+x /var/lib/asterisk/agi-bin/amd.py

### 4️⃣ Remove old 8370 dialplan
echo "🔹 Cleaning any previous 8370 dialplan..."
sed -i '/exten => 8370/d' /etc/asterisk/extensions.conf

### 5️⃣ Append clean AMD dialplan
echo "🔹 Injecting advanced AMD dialplan..."
cat << 'EOF' >> /etc/asterisk/extensions.conf

; AI AMD extension for 8370
exten => 8370,1,AGI(agi://127.0.0.1:4577/call_log)
exten => 8370,n,Playback(sip-silence)
exten => 8370,n,EAGI(/var/lib/asterisk/agi-bin/amd.py)
exten => 8370,n,GotoIf($["${AMDSTATUS}" = "HONEYPOT"]?honeypot)
exten => 8370,n,GotoIf($["${AMDCAUSE}" = "NETERR" | "${AMDCAUSE}" = "INTERR"]?amd_fallback:continue)
exten => 8370,n(amd_fallback),AMD(2000,2000,1000,5000,120,50,4,256)
exten => 8370,n(continue),AGI(VD_amd.agi,${EXTEN})
exten => 8370,n,AGI(agi-VDAD_ALL_outbound.agi,NORMAL-----LB-----${CONNECTEDLINE(name)})
exten => 8370,n(honeypot),Hangup()
EOF

### 6️⃣ Reload Asterisk
echo "🔹 Reloading Asterisk dialplan..."
asterisk -rx "dialplan reload"

echo "✅ AMD advanced installer completed successfully. Dial 8370 to test advanced AMD detection."
