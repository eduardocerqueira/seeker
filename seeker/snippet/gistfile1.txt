#date: 2026-01-29T17:12:56Z
#url: https://api.github.com/gists/075459bdde5e1fe806f54defef2e3d8a
#owner: https://api.github.com/users/darkrival329

#!/usr/bin/env bash
set -euo pipefail

# ---- Required env vars (fail fast with clear errors) ----
: "${BINARY_PATH:?BINARY_PATH is required (e.g. /usr/local/bin/myapp)}"
: "${CI_APPLICATION_REPOSITORY:?CI_APPLICATION_REPOSITORY is required (e.g. registry.gitlab.com/group/project)}"
: "${CI_APPLICATION_TAG:?CI_APPLICATION_TAG is required (e.g. 1.2.3)}"
: "${PACKAGE_NAME:?PACKAGE_NAME is required (e.g. myapp)}"

IMAGE="${CI_APPLICATION_REPOSITORY}:${CI_APPLICATION_TAG}"
CONTAINER_NAME="extract"

cleanup() {
  # Best-effort cleanup
  docker rm -f "${CONTAINER_NAME}" >/dev/null 2>&1 || true
}
trap cleanup EXIT

echo "Extracting ${BINARY_PATH} from image..."
rm -rf ./bin
mkdir -p ./bin

docker create --name "${CONTAINER_NAME}" "${IMAGE}" >/dev/null

# Copy the binary (or file/dir) from the image to ./bin
docker cp "${CONTAINER_NAME}:${BINARY_PATH}" "./bin"

# If the copied item ends up nested, that's fineâ€”tar will include it.
echo "Creating tarball..."
TARBALL="${PACKAGE_NAME}-${CI_APPLICATION_TAG}.tar.gz"
tar -czf "${TARBALL}" bin/

echo "Uploading to package registry..."
echo "TODO: implement upload step (curl to GitLab Generic Package Registry, S3, etc.)"
echo "Created: ${TARBALL}"