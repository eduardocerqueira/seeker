#date: 2021-10-27T16:59:24Z
#url: https://api.github.com/gists/0f99743ca622b9aeccba663ef884c60b
#owner: https://api.github.com/users/eruanno123

#!/bin/bash

# Re-install GRUB when Windows screws it up in the dual-boot system.
# Credits: https://www.youtube.com/watch?v=8hxLIua8SS4
#
# WARNING: USE THIS ON YOUR OWN RISK AND ONLY IF YOU UNDERSTAND 
# WHAT IT IS DOING! YOUR SYSTEM MAY STOP BOOTING UP AND/OR YOUR 
# DATA CAN BE LOST!

# CONFIGURATION: DO NOT FORGET TO ADJUST THE PARTITIONS !!!

mount_point=/mnt/rescue
boot_part=/dev/nvme0n1p1
os_part=/dev/nvme0n1p5

log() {
	2>&1 echo "rescue: $1"
}

die() {
	log "error: $1"
	exit 1
}

log "Creating mount point for chroot: $mount_point"
mkdir -p $mount_point
log "Mounting OS partition: $os_part"
mount $os_part      $mount_point
log "Mounting boot partition: $boot_part"
mount $boot_part    $mount_point/boot/efi
log "Mounting proc"
mount -t proc proc  $mount_point/proc
log "Mounting sysfs"
mount -t sysfs sys  $mount_point/sys
log "Mounting dev"
mount -o bind /dev  $mount_point/dev
log "Mounting dev/pts"
mount -t devpts pts $mount_point/dev/pts
log "Load efivarfs"
modprobe efivarfs
log "Enter chroot: $mount_point"
chroot $mount_point /bin/bash << "EOT"
echo "Mounting efivarfs"
mount -t efivarfs efivarfs /sys/firmware/efi/efivars
echo "Installing GRUB ..."
grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=ubuntu --recheck
echo "Updating GRUB ..."
update-grub
echo "DONE"
EOT
log "Exited chroot. Now reboot the system"
