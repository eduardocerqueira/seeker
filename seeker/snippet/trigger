#date: 2023-01-03T16:53:39Z
#url: https://api.github.com/gists/cc71a0222b975398dcbcfb46d78557d5
#owner: https://api.github.com/users/oliver-sanders

#!/usr/bin/env bash    
                                     
set -eu    
                                   
if [[ $# -lt 1 ]]; then                 
    echo 'Usage ./trigger WORKFLOW_ID [KEY=VALUE ...]' >&2    
    echo                                                                     
    echo 'Trigger a new cycle in the target workflow.'    
    echo 'Any environment variable KEY=VALUE pairs will be broadcasted to'    
    echo 'all tasks in the cycle.'    
    exit 1                    
fi                             
                                                                             
# determine the workflow                                                      
WORKFLOW_ID="$1"                                                              
shift                                                                         
WORKFLOW_RUN_DIR="${HOME}/cylc-run/${WORKFLOW_ID}"                            
EXT_TRIGGER_DIR="${WORKFLOW_RUN_DIR}/triggers"                                
mkdir -p "$EXT_TRIGGER_DIR"                                                   
                                                                              
# pick a trigger-id                                                           
TRIGGER_ID="$(date --iso-8601=seconds)"                                       
                                                                              
# write environment variables to a broadcast fuke                             
TRIGGER_FILE="${EXT_TRIGGER_DIR}/${TRIGGER_ID}.cylc"                          
echo '[environment]' >"$TRIGGER_FILE"                                         
for env in "$@"; do                                                           
    echo $env >> "$TRIGGER_FILE"                                              
done                                                                          
                                                                              
# issue the xtrigger                                                                        
cylc ext-trigger "$WORKFLOW_ID" 'trigger' "$TRIGGER_ID" 