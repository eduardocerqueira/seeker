#date: 2024-02-26T16:57:26Z
#url: https://api.github.com/gists/c0ff7da9cb72008c2252bce14e2a0463
#owner: https://api.github.com/users/Manouchehri

#!/usr/bin/env dash
#
# SPDX-License-Identifier: Unlicense
#

CC=clang
LD=ld.lld
STRIP=llvm-strip

# -fuse-ld= tells compiler to use specific linker above
USE_LD=$(echo $LD | cut -d. -f2)

# Limits to at least Intel Nehalem and newer
ARCH=x86-64-v2
# Optimize binary for this specific CPU
TUNE=skylake

# Compiler optimizations and hardenings
CFLAGS="-O3 -g0 -fcf-protection=full -fstack-clash-protection -fstack-protector-all"
# LLVM-specific hardening, automatically init values with zeroes
CFLAGS="$CFLAGS -ftrivial-auto-var-init=zero -enable-trivial-auto-var-init-zero-knowing-it-will-be-removed-from-clang"

# Linker optimization and static-PIE linking
LDFLAGS="-Wl,-O3 -static-pie"

# Removes all symbols
STRIPFLAGS="-s"

# shellcheck disable=SC2086
$CC -march=$ARCH -mtune=$TUNE $CFLAGS \
    -fuse-ld="$USE_LD" $LDFLAGS \
    dtbtool.c -o dtbToolLineage

$STRIP $STRIPFLAGS dtbToolLineage

ls -l dtbToolLineage
sha256sum dtbToolLineage
